import React, { useRef, useState, useEffect } from 'react';
import Select, { SelectContent, SelectItem, SelectTrigger, SelectValue } from './components/ui/select'; // Asegúrate de que la ruta es correcta
import './photo-to-stencil-app.css'; // Asegúrate de que el archivo CSS está en la misma carpeta o usa una ruta relativa

const PhotoToStencilApp = () => {
  const [image, setImage] = useState(null);
  const [processedImage, setProcessedImage] = useState(null);
  const [contrast, setContrast] = useState(50);
  const [threshold, setThreshold] = useState(128);
  const [lineThickness, setLineThickness] = useState(1);
  const [sharpness, setSharpness] = useState(50);
  const [preset, setPreset] = useState('custom');
  const fileInputRef = useRef(null);
  const canvasRef = useRef(null);

  useEffect(() => {
    if (image) {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        applyStencilEffect();
      };
      img.src = image;
    }
  }, [image, contrast, threshold, lineThickness, sharpness, preset]);

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image')) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result);
        setProcessedImage(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const applyStencilEffect = () => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const kernelSize = 3;
    const halfKernel = Math.floor(kernelSize / 2);
    const tempData = new Uint8ClampedArray(data);

    // Apply sharpen kernel
    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        let sum = 0;
        for (let ky = -halfKernel; ky <= halfKernel; ky++) {
          for (let kx = -halfKernel; kx <= halfKernel; kx++) {
            const px = Math.min(Math.max(0, x + kx), canvas.width - 1);
            const py = Math.min(Math.max(0, y + ky), canvas.height - 1);
            const weight = 1; // Define your kernel weight here
            sum += tempData[(py * canvas.width + px) * 4] * weight;
          }
        }
        data[(y * canvas.width + x) * 4] = Math.min(Math.max(0, sum), 255);
      }
    }

    // Apply contrast and threshold
    for (let i = 0; i < data.length; i += 4) {
      const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
      const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
      const newValue = factor * (avg - 128) + 128;
      const val = newValue >= threshold ? 255 : 0;
      data[i] = data[i + 1] = data[i + 2] = val;
    }

    // Apply line thickness
    for (let i = 0; i < data.length; i += 4) {
      if (data[i] === 255) {
        for (let ky = -lineThickness; ky <= lineThickness; ky++) {
          for (let kx = -lineThickness; kx <= lineThickness; kx++) {
            const nx = i / 4 % canvas.width + kx;
            const ny = Math.floor(i / 4 / canvas.width) + ky;
            if (nx >= 0 && nx < canvas.width && ny >= 0 && ny < canvas.height) {
              const ni = (ny * canvas.width + nx) * 4;
              data[ni] = data[ni + 1] = data[ni + 2] = 255;
              data[ni + 3] = 255;
            }
          }
        }
      }
    }

    ctx.putImageData(imageData, 0, 0);
    setProcessedImage(canvas.toDataURL('image/png'));
  };

  const handlePresetChange = (value) => {
    setPreset(value);
    const presets = {
      custom: { contrast: 50, threshold: 128, lineThickness: 1, sharpness: 50 },
      stencil: { contrast: 128, threshold: 180, lineThickness: 2, sharpness: 80 },
      lineart: { contrast: 100, threshold: 100, lineThickness: 1, sharpness: 60 },
      pattern: { contrast: 60, threshold: 200, lineThickness: 3, sharpness: 70 },
    };
    const preset = presets[value];
    setContrast(preset.contrast);
    setThreshold(preset.threshold);
    setLineThickness(preset.lineThickness);
    setSharpness(preset.sharpness);
  };

  return (
    <div className="photo-to-stencil-app">
      <h1>Trazado Automático a Stencil/Patrón</h1>
      <input
        type="file"
        accept="image/*"
        onChange={handleImageUpload}
        ref={fileInputRef}
      />
      <canvas ref={canvasRef}></canvas>
      {processedImage && (
        <div>
          <h2>Processed Image</h2>
          <img src={processedImage} alt="Processed" />
        </div>
      )}
      <Select onValueChange={handlePresetChange}>
        <SelectTrigger>
          <SelectValue placeholder="Select a Preset" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="custom">Custom</SelectItem>
          <SelectItem value="stencil">Stencil</SelectItem>
          <SelectItem value="lineart">Line Art</SelectItem>
          <SelectItem value="pattern">Pattern</SelectItem>
        </SelectContent>
      </Select>
    </div>
  );
};

export default PhotoToStencilApp;
